<html>
<script id="base-function" type="text/javascript">
	if(typeof Object.beget !== 'function')
	{
		Object.create = function(o)
		{
			var F = function(){};
			F.prototype = o;
			return new F();
		}

	}	

	var ButtonClass = 
	{
		left : 0,
		top : 0,
		width : 0,
		height : 0,
		onclick : function(){},
	}

	var MinesGameClass = 
	{
		var unopen : "u",
		var rows : function()
		{
			return this["-minesLayout"].rows();
		},
		var cols : function()
		{
			return this["-minesLayout"].cols();
		},
		var validateIndex2D : function(row, col)
		{
			return this["-minesLayout"].validateIndex2D(row, col);
		},
		var init_rows_cols_mines : function (rows, cols, mines)
		{
			alert("successed");
			this["-minesLayout"] = Object.create(MinesLayoutClass).init_width_height_mines(cols, rows, minesNumber);
			var gameLayout = this["-gameLayout"] = [];
			var i = 0;
			var j = 0;
			for(i = 0; i < this.rows(); ++i)
			{
				gameLayout[i] = [];
				for(j = 0; j < this.cols(); ++j)
				{
					gameLayout[i][j] = unopen;
				}
			}
			alert("successed");
		},
		var get : function(row, col)
		{
			var status;
			if(this.validateIndex2D(row, col))
			{
				status = this["-gameLayout"][row][col];
			}
			return status;
		},
		var set : function(row, col, status)
		{
			var isSet = false;
			if(this.validateIndex2D(row, col))
			{
				this["-gameLayout"][row][col] = status;
				isSet = true;
			}
			return isSet;
		},
		var open : function(row ,col)
		{
			if(this.get(row, col) == unopen)
			{
				this.set(row, col, String(this["-minesLayout"].get2D(row, col)));
			}
		},
	}

	var MinesLayoutClass = 
	{
		//修正项：参数名i,j替换为row,col
		indexToIndex2D : function(i){
			return [Math.floor(i / this.w), i % this.w];
		},
		index2DToIndex : function(i, j){//i:row, j:col
			return i * this.w + j;
		},
		get : function(i){
			var array = this["-minesArray"];
			return array[i];
		},
		get2D : function(i, j){
			return this.get(this.index2DToIndex(i, j));
		},
		set : function(i, v){
			var array = this["-minesArray"];
			array[i] = v;
		},
		set2D : function(i, j, v){
			this.set(this.index2DToIndex(i, j), v);
		},
		rows : function(){
			return this.h;
		},
		cols : function(){
			return this.w;
		},
		// "-getNeighbor" : function(i){
		// },
		validateIndex2D : function(i, j){
			return i >= 0 && i < this.rows() && j >= 0 && j < this.cols();
		},
		"-getNeighbor2D" : function(i, j){
			var neighborArray = [];
			if(this.validateIndex2D(i, j))
			{
				var row = i;
				var col = j;
				var neighborOffsetArrayIt = 0;
				var neighborOffset = [];
				var neighbor = [];
				var neighborOffsetArray = [
					[-1, -1],
					[-1,  0],
					[-1,  1],
					[ 0, -1],
					//[ 0,  0],
					[ 0,  1],
					[ 1, -1],
					[ 1,  0],
					[ 1,  1],
				];
				for(neighborOffsetArrayIt = 0; neighborOffsetArrayIt < neighborOffsetArray.length; neighborOffsetArrayIt += 1)
				{
					neighborOffset = neighborOffsetArray[neighborOffsetArrayIt];
					neighbor = [row + neighborOffset[0], col + neighborOffset[1]];
					if(this.validateIndex2D(neighbor[0], neighbor[1]))
					{
						neighborArray.push(neighbor);
					}
				}
			}
			return neighborArray;
		},
		init_width_height_mines : function(w, h, mines)
		{
			this.w = w;
			this.h = h;
			this.mines = mines;
			var minesArray = this["-minesArray"] = [];
			var _self = this;
			(function()
			{
				var i = 0;
				var j = 0;
				var k = 0;
				var neighborMines = 0;
				for(; i < mines; i += 1)
					minesArray[i] = -1;

				for(; i < w * h; i += 1)
					minesArray[i] = 0;

				for(i = 0; i < w * h; i += 1)
				{
					var random_offset = Math.floor(Math.random() * (w * h - 1 - i));
					//swap(minesArray[i], minesArray[i + offset]);
					var temp = minesArray[i];
					minesArray[i] = minesArray[i + random_offset];
					minesArray[i + random_offset] = temp;
				}
				for(i = 0; i < _self.rows(); i += 1)
				{
					for(j = 0; j < _self.cols(); j += 1)
					{
						var neighborArray = _self["-getNeighbor2D"](i ,j);
						neighborMines = 0;
						for(k = 0; k < neighborArray.length; k += 1)
						{
							if(_self.get2D(neighborArray[k][0], neighborArray[k][1]) < 0)
							{
								neighborMines += 1;
							}
						}
						_self.set2D(i, j, neighborMines);
					}
				}
			})();
			return this;
		},
	}
</script>

<script id="game-code" type="text/javascript">
	var cols = 10;
	var rows = 5;
	var mines = 10;
	var minesLayout = Object.create(MinesGameClass).init_rows_cols_mines(rows, cols, mines);
</script>

<body id="gameZoneNode" onload="buildMine()">
	<div>
		<span>
			kkk
		</span>
		<p id = "spantest">
			@@@
		</p>
	</div>
	<div>
		xxxx
		<span style="background-color:red;" onmousedown="alert('sdf')">
			ttt
		</span>
	</div>
</body>
</html>

<html>
<script id="base-function" type="text/javascript">
	if(typeof Object.beget !== 'function')
	{
		Object.create = function(o)
		{
			var F = function(){};
			F.prototype = o;
			return new F();
		}

	}	

	var ButtonClass = 
	{
		left : 0,
		top : 0,
		width : 0,
		height : 0,
		onclick : function(){},
	}

	var MinesGameUIClass = 
	{
		buttonWidth : 30,
		buttonHeight : 30,
		buttonBorderStyle : "solid",
		buttonBorderWidth : 1,
		cellUnopenColor : "#C3C3C3",
		cellOpenColor : "#F0EDC4",

		init : function()
		{
			this.rows = 0;
			this.cols = 0;
			this.mines = 0;
			return this;
		},
		reset : function(rows, cols, mines)
		{
			this.rows = rows;
			this.cols = cols;
			this.mines = mines;
			this["-minesGame"] = Object.create(MinesGameClass).init_rows_cols_mines(rows, cols, mines);
			this["-draw"]();
		},
		"-createButton" :  function(x, y)
		{
			var button = document.createElement("div");
			button.style.left = x;
			button.style.top = y;
			button.style.width = this.buttonWidth;
			button.style.height = this.buttonHeight;
			button.style.position = "absolute";
			button.style.backgroundColor = this.cellUnopenColor;
			button.style.borderStyle = this.buttonBorderStyle;
			button.style.borderWidth = this.buttonBorderWidth;
			button.style.textAlign = "center";
			button.onclick = this["-buttonAction"];
			var node=document.createTextNode("");
			button.appendChild(node);
			return button;
		},
		"-buttonAction" : function(event)
		{
			var openedCellArray = event.target.game["-minesGame"].open(event.target.cellIndex[0], event.target.cellIndex[1]);
			var i = 0;
			for(i = 0; i < openedCellArray.length; i += 1)
			{
				event.target.game["-redrawCell"](openedCellArray[i][0], openedCellArray[i][1]);
			}
		},
		"-draw" : function()
		{
			var minesCanvas = document.getElementById('GameCanvas');
			var i = 0;
			var j = 0;
			var x = 0;
			var y = 0;
			var button;
			this["-buttons"] = [];
			for(i = 0; i < this.rows; i += 1)
			{
				x = 0;
				this["-buttons"][i] = [];
				for(j = 0; j < this.cols; j += 1)
				{
					button = this["-createButton"](x, y);
					minesCanvas.appendChild(button);
					button.cellIndex = [i, j];
					button.game = this;
					this["-buttons"][i][j] = button;
					x += this.buttonWidth;
				}
				y += this.buttonHeight;
			}
		},
		"-redrawCell" : function(row, col)
		{
			var button = this["-buttons"][row][col];
			var status = this["-minesGame"].get(row, col);
			if(status == MinesGameClass.unopen)
			{
				button.style.backgroundColor = this.cellUnopenColor;
			}
			else
			{
				button.style.backgroundColor = this.cellOpenColor;
				button.innerHTML = status;
			}
		},
	}

	var MinesGameClass = 
	{
		unopen : "u",
		rows : function()
		{
			return this["-minesLayout"].rows();
		},
		cols : function()
		{
			return this["-minesLayout"].cols();
		},
		validateIndex2D : function(row, col)
		{
			return this["-minesLayout"].validateIndex2D(row, col);
		},
		init_rows_cols_mines : function (rows, cols, mines)
		{
			this["-minesLayout"] = Object.create(MinesLayoutClass).init_width_height_mines(cols, rows, mines);
			var gameLayout = this["-gameLayout"] = [];
			var i = 0;
			var j = 0;
			for(i = 0; i < this.rows(); i += 1)
			{
				gameLayout[i] = [];
				for(j = 0; j < this.cols(); j += 1)
				{
					gameLayout[i][j] = this.unopen;
				}
			}
			return this;
		},
		get : function(row, col)
		{
			var status;
			if(this.validateIndex2D(row, col))
			{
				status = this["-gameLayout"][row][col];
			}
			return status;
		},
		"-set" : function(row, col, status)
		{
			var isSet = false;
			if(this.validateIndex2D(row, col))
			{
				this["-gameLayout"][row][col] = status;
				isSet = true;
			}
			return isSet;
		},
		open : function(row ,col)
		{
			var openedCellArray = [];
			var mines = this["-minesLayout"].get2D(row, col);
			var neighbors;
			var i;
			if(this.get(row, col) == this.unopen)
			{
				this["-set"](row, col, String(mines));
				if(mines == 0)
				{
					neighbors = this["-minesLayout"]["-getNeighbor2D"](row, col);
					for(i = 0; i < neighbors.length; i += 1)
					{
						if(this["-minesLayout"].get2D(neighbors[i][0], neighbors[i][1]) >= 0)
						{
							openedCellArray = openedCellArray.concat(this.open(neighbors[i][0], neighbors[i][1]));
						}
					}
				}
				openedCellArray.push([row, col]);
			}
			return openedCellArray;
		},
	}

	var MinesLayoutClass = 
	{
		//修正项：参数名i,j替换为row,col
		indexToIndex2D : function(i){
			return [Math.floor(i / this.w), i % this.w];
		},
		index2DToIndex : function(i, j){//i:row, j:col
			return i * this.w + j;
		},
		get : function(i){
			var array = this["-minesArray"];
			return array[i];
		},
		get2D : function(i, j){
			return this.get(this.index2DToIndex(i, j));
		},
		set : function(i, v){
			var array = this["-minesArray"];
			array[i] = v;
		},
		set2D : function(i, j, v){
			this.set(this.index2DToIndex(i, j), v);
		},
		rows : function(){
			return this.h;
		},
		cols : function(){
			return this.w;
		},
		// "-getNeighbor" : function(i){
		// },
		validateIndex2D : function(i, j){
			return i >= 0 && i < this.rows() && j >= 0 && j < this.cols();
		},
		"-getNeighbor2D" : function(i, j){
			var neighborArray = [];
			if(this.validateIndex2D(i, j))
			{
				var row = i;
				var col = j;
				var neighborOffsetArrayIt = 0;
				var neighborOffset = [];
				var neighbor = [];
				var neighborOffsetArray = [
					[-1, -1],
					[-1,  0],
					[-1,  1],
					[ 0, -1],
					//[ 0,  0],
					[ 0,  1],
					[ 1, -1],
					[ 1,  0],
					[ 1,  1],
				];
				for(neighborOffsetArrayIt = 0; neighborOffsetArrayIt < neighborOffsetArray.length; neighborOffsetArrayIt += 1)
				{
					neighborOffset = neighborOffsetArray[neighborOffsetArrayIt];
					neighbor = [row + neighborOffset[0], col + neighborOffset[1]];
					if(this.validateIndex2D(neighbor[0], neighbor[1]))
					{
						neighborArray.push(neighbor);
					}
				}
			}
			return neighborArray;
		},
		init_width_height_mines : function(w, h, mines)
		{
			this.w = w;
			this.h = h;
			this.mines = mines;
			var minesArray = this["-minesArray"] = [];
			var _self = this;
			(function()
			{
				var i = 0;
				var j = 0;
				var k = 0;
				var neighborMines = 0;
				for(; i < mines; i += 1)
					minesArray[i] = -1;

				for(; i < w * h; i += 1)
					minesArray[i] = 0;

				for(i = 0; i < w * h; i += 1)
				{
					var random_offset = Math.floor(Math.random() * (w * h - 1 - i));
					//swap(minesArray[i], minesArray[i + offset]);
					var temp = minesArray[i];
					minesArray[i] = minesArray[i + random_offset];
					minesArray[i + random_offset] = temp;
				}
				for(i = 0; i < _self.rows(); i += 1)
				{
					for(j = 0; j < _self.cols(); j += 1)
					{
						if(_self.get2D(i, j) == 0)
						{
							var neighborArray = _self["-getNeighbor2D"](i ,j);
							neighborMines = 0;
							for(k = 0; k < neighborArray.length; k += 1)
							{
								if(_self.get2D(neighborArray[k][0], neighborArray[k][1]) < 0)
								{
									neighborMines += 1;
								}
							}
							_self.set2D(i, j, neighborMines);
						}
					}
				}
			})();
			return this;
		},
	}
</script>

<body id="gameZoneNode" onload="buildMine()">
	<div>
		<span>
			kkk
		</span>
		<p id = "spantest">
			@@@
		</p>
	</div>
	<div>
		xxxx
		<span style="background-color:red;" onmousedown="alert('sdf')">
			ttt
		</span>
	</div>
	<div id = "GameCanvas">
	</div>
</body>

<script id="game-code" type="text/javascript">
	var cols = 10;
	var rows = 5;
	var mines = 10;
	var minesGame = Object.create(MinesGameUIClass).init();
	minesGame.reset(rows, cols, mines);
	alert("script right");
</script>

</html>
